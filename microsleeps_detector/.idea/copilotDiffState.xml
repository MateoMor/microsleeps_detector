<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/build.gradle.kts">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/build.gradle.kts" />
              <option name="originalContent" value="plugins {&#10;    alias(libs.plugins.android.application)&#10;    alias(libs.plugins.kotlin.android)&#10;}&#10;&#10;android {&#10;    namespace = &quot;com.example.microsleeps_detector&quot;&#10;    compileSdk {&#10;        version = release(36)&#10;    }&#10;&#10;    defaultConfig {&#10;        applicationId = &quot;com.example.microsleeps_detector&quot;&#10;        minSdk = 25&#10;        targetSdk = 36&#10;        versionCode = 1&#10;        versionName = &quot;1.0&quot;&#10;&#10;        testInstrumentationRunner = &quot;androidx.test.runner.AndroidJUnitRunner&quot;&#10;    }&#10;&#10;    buildTypes {&#10;        release {&#10;            isMinifyEnabled = false&#10;            proguardFiles(&#10;                getDefaultProguardFile(&quot;proguard-android-optimize.txt&quot;),&#10;                &quot;proguard-rules.pro&quot;&#10;            )&#10;        }&#10;    }&#10;    compileOptions {&#10;        sourceCompatibility = JavaVersion.VERSION_11&#10;        targetCompatibility = JavaVersion.VERSION_11&#10;    }&#10;    kotlinOptions {&#10;        jvmTarget = &quot;11&quot;&#10;    }&#10;    buildFeatures {&#10;        viewBinding = true&#10;    }&#10;}&#10;&#10;&#10;val cameraxVersion = &quot;1.5.1&quot;&#10;&#10;dependencies {&#10;    implementation(libs.androidx.core.ktx)&#10;    implementation(libs.androidx.appcompat)&#10;    implementation(libs.material)&#10;    implementation(libs.androidx.constraintlayout)&#10;    implementation(libs.androidx.navigation.fragment.ktx)&#10;    implementation(libs.androidx.navigation.ui.ktx)&#10;    testImplementation(libs.junit)&#10;    androidTestImplementation(libs.androidx.junit)&#10;    androidTestImplementation(libs.androidx.espresso.core)&#10;&#10;    implementation(&quot;androidx.camera:camera-core:$cameraxVersion&quot;)&#10;    implementation(&quot;androidx.camera:camera-camera2:$cameraxVersion&quot;)&#10;    implementation(&quot;androidx.camera:camera-lifecycle:$cameraxVersion&quot;)&#10;    implementation(&quot;androidx.camera:camera-view:$cameraxVersion&quot;)&#10;    implementation(&quot;androidx.camera:camera-video:$cameraxVersion&quot;)&#10;&#10;    // MediaPipe Tasks Vision (Face Landmarker)&#10;    implementation(&quot;com.google.mediapipe:tasks-vision:0.10.18&quot;)&#10;&#10;&#10;    // MJPEG View Library&#10;    implementation(&quot;com.github.niqdev:ipcam-view:2.1.0&quot;)&#10;    implementation(&quot;com.squareup.okhttp3:okhttp:4.12.0&quot;)&#10;}" />
              <option name="updatedContent" value="plugins {&#10;    alias(libs.plugins.android.application)&#10;    alias(libs.plugins.kotlin.android)&#10;}&#10;&#10;android {&#10;    namespace = &quot;com.example.microsleeps_detector&quot;&#10;    compileSdk {&#10;        version = release(36)&#10;    }&#10;&#10;    defaultConfig {&#10;        applicationId = &quot;com.example.microsleeps_detector&quot;&#10;        minSdk = 25&#10;        targetSdk = 36&#10;        versionCode = 1&#10;        versionName = &quot;1.0&quot;&#10;&#10;        testInstrumentationRunner = &quot;androidx.test.runner.AndroidJUnitRunner&quot;&#10;    }&#10;&#10;    buildTypes {&#10;        release {&#10;            isMinifyEnabled = false&#10;            proguardFiles(&#10;                getDefaultProguardFile(&quot;proguard-android-optimize.txt&quot;),&#10;                &quot;proguard-rules.pro&quot;&#10;            )&#10;        }&#10;    }&#10;    compileOptions {&#10;        sourceCompatibility = JavaVersion.VERSION_11&#10;        targetCompatibility = JavaVersion.VERSION_11&#10;    }&#10;    kotlinOptions {&#10;        jvmTarget = &quot;11&quot;&#10;    }&#10;    buildFeatures {&#10;        viewBinding = true&#10;    }&#10;}&#10;&#10;&#10;val cameraxVersion = &quot;1.5.1&quot;&#10;&#10;dependencies {&#10;    implementation(libs.androidx.core.ktx)&#10;    implementation(libs.androidx.appcompat)&#10;    implementation(libs.material)&#10;    implementation(libs.androidx.constraintlayout)&#10;    implementation(libs.androidx.navigation.fragment.ktx)&#10;    implementation(libs.androidx.navigation.ui.ktx)&#10;    testImplementation(libs.junit)&#10;    androidTestImplementation(libs.androidx.junit)&#10;    androidTestImplementation(libs.androidx.espresso.core)&#10;&#10;    implementation(&quot;androidx.camera:camera-core:$cameraxVersion&quot;)&#10;    implementation(&quot;androidx.camera:camera-camera2:$cameraxVersion&quot;)&#10;    implementation(&quot;androidx.camera:camera-lifecycle:$cameraxVersion&quot;)&#10;    implementation(&quot;androidx.camera:camera-view:$cameraxVersion&quot;)&#10;    implementation(&quot;androidx.camera:camera-video:$cameraxVersion&quot;)&#10;&#10;    // Lifecycle Service to bind CameraX to service lifecycle&#10;    implementation(&quot;androidx.lifecycle:lifecycle-service:2.8.6&quot;)&#10;&#10;    // MediaPipe Tasks Vision (Face Landmarker)&#10;    implementation(&quot;com.google.mediapipe:tasks-vision:0.10.18&quot;)&#10;&#10;&#10;    // MJPEG View Library&#10;    implementation(&quot;com.github.niqdev:ipcam-view:2.1.0&quot;)&#10;    implementation(&quot;com.squareup.okhttp3:okhttp:4.12.0&quot;)&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/AndroidManifest.xml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/AndroidManifest.xml" />
              <option name="originalContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.CAMERA&quot;/&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.VIBRATE&quot;/&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE&quot;/&gt;&#10;    &lt;!-- Optional, required on Android 13+ to show notifications --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.POST_NOTIFICATIONS&quot; tools:targetApi=&quot;33&quot; /&gt;&#10;    &lt;uses-feature android:name=&quot;android.hardware.camera.any&quot;/&gt;&#10;&#10;    &lt;application&#10;        android:allowBackup=&quot;true&quot;&#10;        android:dataExtractionRules=&quot;@xml/data_extraction_rules&quot;&#10;        android:fullBackupContent=&quot;@xml/backup_rules&quot;&#10;        android:icon=&quot;@mipmap/ic_launcher&quot;&#10;        android:label=&quot;@string/app_name&quot;&#10;        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;&#10;        android:supportsRtl=&quot;true&quot;&#10;        android:theme=&quot;@style/Theme.Microsleeps_detector&quot;&#10;        android:usesCleartextTraffic=&quot;true&quot;&gt;&#10;        &lt;activity&#10;            android:name=&quot;.MainActivity&quot;&#10;            android:exported=&quot;true&quot;&#10;            android:theme=&quot;@style/Theme.Microsleeps_detector&quot;&gt;&#10;            &lt;intent-filter&gt;&#10;                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;&#10;&#10;                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;&#10;            &lt;/intent-filter&gt;&#10;        &lt;/activity&gt;&#10;&#10;        &lt;service&#10;            android:name=&quot;.DrowsinessDetectionService&quot;&#10;            android:exported=&quot;false&quot;&#10;            android:foregroundServiceType=&quot;dataSync&quot; /&gt;&#10;&#10;    &lt;/application&gt;&#10;&#10;&lt;/manifest&gt;" />
              <option name="updatedContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.CAMERA&quot;/&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.VIBRATE&quot;/&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE&quot;/&gt;&#10;    &lt;!-- Optional, required on Android 13+ to show notifications --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.POST_NOTIFICATIONS&quot; tools:targetApi=&quot;33&quot; /&gt;&#10;    &lt;!-- Foreground camera service permission for newer targets --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE_CAMERA&quot; tools:targetApi=&quot;34&quot; /&gt;&#10;    &lt;uses-feature android:name=&quot;android.hardware.camera.any&quot;/&gt;&#10;&#10;    &lt;application&#10;        android:allowBackup=&quot;true&quot;&#10;        android:dataExtractionRules=&quot;@xml/data_extraction_rules&quot;&#10;        android:fullBackupContent=&quot;@xml/backup_rules&quot;&#10;        android:icon=&quot;@mipmap/ic_launcher&quot;&#10;        android:label=&quot;@string/app_name&quot;&#10;        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;&#10;        android:supportsRtl=&quot;true&quot;&#10;        android:theme=&quot;@style/Theme.Microsleeps_detector&quot;&#10;        android:usesCleartextTraffic=&quot;true&quot;&gt;&#10;        &lt;activity&#10;            android:name=&quot;.MainActivity&quot;&#10;            android:exported=&quot;true&quot;&#10;            android:theme=&quot;@style/Theme.Microsleeps_detector&quot;&gt;&#10;            &lt;intent-filter&gt;&#10;                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;&#10;&#10;                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;&#10;            &lt;/intent-filter&gt;&#10;        &lt;/activity&gt;&#10;&#10;        &lt;service&#10;            android:name=&quot;.DrowsinessDetectionService&quot;&#10;            android:exported=&quot;false&quot;&#10;            android:foregroundServiceType=&quot;camera|dataSync&quot; /&gt;&#10;&#10;    &lt;/application&gt;&#10;&#10;&lt;/manifest&gt;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/microsleeps_detector/Dashboard.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/microsleeps_detector/Dashboard.kt" />
              <option name="originalContent" value="package com.example.microsleeps_detector&#10;&#10;import android.Manifest&#10;import android.content.ComponentName&#10;import android.content.Context&#10;import android.content.Intent&#10;import android.content.ServiceConnection&#10;import android.content.pm.PackageManager&#10;import android.graphics.Bitmap&#10;import android.os.Build&#10;import android.os.Bundle&#10;import android.os.IBinder&#10;import androidx.fragment.app.Fragment&#10;import android.view.LayoutInflater&#10;import android.view.View&#10;import android.view.ViewGroup&#10;import android.widget.Toast&#10;import androidx.core.content.ContextCompat&#10;import androidx.navigation.fragment.findNavController&#10;import com.example.microsleeps_detector.databinding.DashboardBinding&#10;&#10;/**&#10; * A simple [Fragment] subclass as the default destination in the navigation.&#10; */&#10;class Dashboard : Fragment() {&#10;&#10;    private var _binding: DashboardBinding? = null&#10;    private val binding get() = _binding!!&#10;&#10;    private var serviceBound = false&#10;    private var service: DrowsinessDetectionService? = null&#10;    private var stateListener: ((String) -&gt; Unit)? = null&#10;    private var frameListener: ((Bitmap) -&gt; Unit)? = null&#10;&#10;    private val serviceConnection = object : ServiceConnection {&#10;        override fun onServiceConnected(name: ComponentName?, binder: IBinder?) {&#10;            val local = binder as? DrowsinessDetectionService.LocalBinder&#10;            service = local?.getService()&#10;            serviceBound = service != null&#10;            // Subscribe to status updates&#10;            stateListener = { state -&gt; updateServiceStatus(state) }&#10;            stateListener?.let { service?.addStateListener(it) }&#10;            // Subscribe to debug frames&#10;            frameListener = { bmp -&gt;&#10;                // Ensure main thread update&#10;                view?.post {&#10;                    binding.debugFrame.setImageBitmap(bmp)&#10;                }&#10;            }&#10;            frameListener?.let { service?.addFrameListener(it) }&#10;        }&#10;&#10;        override fun onServiceDisconnected(name: ComponentName?) {&#10;            // Unsubscribe listeners&#10;            stateListener?.let { service?.removeStateListener(it) }&#10;            frameListener?.let { service?.removeFrameListener(it) }&#10;            stateListener = null&#10;            frameListener = null&#10;            service = null&#10;            serviceBound = false&#10;        }&#10;    }&#10;&#10;    override fun onCreateView(&#10;        inflater: LayoutInflater, container: ViewGroup?,&#10;        savedInstanceState: Bundle?&#10;    ): View {&#10;        _binding = DashboardBinding.inflate(inflater, container, false)&#10;        return binding.root&#10;    }&#10;&#10;    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {&#10;        super.onViewCreated(view, savedInstanceState)&#10;&#10;        binding.buttonFirst.setOnClickListener {&#10;            findNavController().navigate(R.id.action_dashboard_to_camera)&#10;        }&#10;&#10;        binding.buttonStream.setOnClickListener {&#10;            findNavController().navigate(R.id.action_dashboard_to_stream)&#10;        }&#10;&#10;        binding.startServiceBtn.setOnClickListener {&#10;            ensureNotificationPermissionAndStart()&#10;        }&#10;&#10;        binding.stopServiceBtn.setOnClickListener {&#10;            stopBackgroundService()&#10;        }&#10;&#10;        // Try binding if service is already running&#10;        bindToService()&#10;    }&#10;&#10;    private fun ensureNotificationPermissionAndStart() {&#10;        if (Build.VERSION.SDK_INT &gt;= 33) {&#10;            val granted = ContextCompat.checkSelfPermission(requireContext(), Manifest.permission.POST_NOTIFICATIONS) == PackageManager.PERMISSION_GRANTED&#10;            if (!granted) {&#10;                requestPermissions(arrayOf(Manifest.permission.POST_NOTIFICATIONS), 1001)&#10;                // We'll handle start upon permission result in onRequestPermissionsResult&#10;                return&#10;            }&#10;        }&#10;        startBackgroundService()&#10;    }&#10;&#10;    private fun startBackgroundService() {&#10;        val url = binding.streamUrlInput.text?.toString()?.trim().orEmpty()&#10;        if (url.isEmpty()) {&#10;            Toast.makeText(requireContext(), &quot;Ingresa la URL del stream&quot;, Toast.LENGTH_SHORT).show()&#10;            return&#10;        }&#10;&#10;        val intent = Intent(requireContext(), DrowsinessDetectionService::class.java).apply {&#10;            action = DrowsinessDetectionService.ACTION_START&#10;            putExtra(DrowsinessDetectionService.EXTRA_STREAM_URL, url)&#10;            // Optional: expose frame timeout tuning from UI later&#10;            // putExtra(DrowsinessDetectionService.EXTRA_FRAME_TIMEOUT_MS, 3000L)&#10;        }&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {&#10;            requireContext().startForegroundService(intent)&#10;        } else {&#10;            requireContext().startService(intent)&#10;        }&#10;        bindToService()&#10;        updateServiceStatus(&quot;Iniciando…&quot;)&#10;    }&#10;&#10;    private fun stopBackgroundService() {&#10;        val intent = Intent(requireContext(), DrowsinessDetectionService::class.java).apply {&#10;            action = DrowsinessDetectionService.ACTION_STOP&#10;        }&#10;        requireContext().startService(intent)&#10;        unbindFromService()&#10;        updateServiceStatus(&quot;Estado del servicio: Inactivo&quot;)&#10;        // Clear debug frame&#10;        binding.debugFrame.setImageDrawable(null)&#10;    }&#10;&#10;    private fun bindToService() {&#10;        val intent = Intent(requireContext(), DrowsinessDetectionService::class.java)&#10;        requireContext().bindService(intent, serviceConnection, Context.BIND_AUTO_CREATE)&#10;    }&#10;&#10;    private fun unbindFromService() {&#10;        if (serviceBound) {&#10;            stateListener?.let { service?.removeStateListener(it) }&#10;            frameListener?.let { service?.removeFrameListener(it) }&#10;            stateListener = null&#10;            frameListener = null&#10;            requireContext().unbindService(serviceConnection)&#10;            serviceBound = false&#10;        }&#10;    }&#10;&#10;    private fun updateServiceStatus(state: String) {&#10;        binding.serviceStatusText.text = &quot;Estado del servicio: $state&quot;&#10;    }&#10;&#10;    override fun onRequestPermissionsResult(requestCode: Int, permissions: Array&lt;out String&gt;, grantResults: IntArray) {&#10;        super.onRequestPermissionsResult(requestCode, permissions, grantResults)&#10;        if (requestCode == 1001) {&#10;            if (grantResults.isNotEmpty() &amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {&#10;                startBackgroundService()&#10;            } else {&#10;                Toast.makeText(requireContext(), &quot;Permiso de notificaciones denegado&quot;, Toast.LENGTH_SHORT).show()&#10;            }&#10;        }&#10;    }&#10;&#10;    override fun onDestroyView() {&#10;        super.onDestroyView()&#10;        unbindFromService()&#10;        _binding = null&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.example.microsleeps_detector&#10;&#10;import android.Manifest&#10;import android.content.ComponentName&#10;import android.content.Context&#10;import android.content.Intent&#10;import android.content.ServiceConnection&#10;import android.content.pm.PackageManager&#10;import android.graphics.Bitmap&#10;import android.os.Build&#10;import android.os.Bundle&#10;import android.os.IBinder&#10;import androidx.fragment.app.Fragment&#10;import android.view.LayoutInflater&#10;import android.view.View&#10;import android.view.ViewGroup&#10;import android.widget.Toast&#10;import androidx.core.content.ContextCompat&#10;import androidx.navigation.fragment.findNavController&#10;import com.example.microsleeps_detector.databinding.DashboardBinding&#10;&#10;/**&#10; * A simple [Fragment] subclass as the default destination in the navigation.&#10; */&#10;class Dashboard : Fragment() {&#10;&#10;    private var _binding: DashboardBinding? = null&#10;    private val binding get() = _binding!!&#10;&#10;    private var serviceBound = false&#10;    private var service: DrowsinessDetectionService? = null&#10;    private var stateListener: ((String) -&gt; Unit)? = null&#10;    private var frameListener: ((Bitmap) -&gt; Unit)? = null&#10;&#10;    private val REQ_NOTIF = 1001&#10;    private val REQ_CAMERA = 1002&#10;&#10;    private val serviceConnection = object : ServiceConnection {&#10;        override fun onServiceConnected(name: ComponentName?, binder: IBinder?) {&#10;            val local = binder as? DrowsinessDetectionService.LocalBinder&#10;            service = local?.getService()&#10;            serviceBound = service != null&#10;            // Subscribe to status updates&#10;            stateListener = { state -&gt; updateServiceStatus(state) }&#10;            stateListener?.let { service?.addStateListener(it) }&#10;            // Subscribe to debug frames&#10;            frameListener = { bmp -&gt;&#10;                // Ensure main thread update&#10;                view?.post {&#10;                    binding.debugFrame.setImageBitmap(bmp)&#10;                }&#10;            }&#10;            frameListener?.let { service?.addFrameListener(it) }&#10;        }&#10;&#10;        override fun onServiceDisconnected(name: ComponentName?) {&#10;            // Unsubscribe listeners&#10;            stateListener?.let { service?.removeStateListener(it) }&#10;            frameListener?.let { service?.removeFrameListener(it) }&#10;            stateListener = null&#10;            frameListener = null&#10;            service = null&#10;            serviceBound = false&#10;        }&#10;    }&#10;&#10;    override fun onCreateView(&#10;        inflater: LayoutInflater, container: ViewGroup?,&#10;        savedInstanceState: Bundle?&#10;    ): View {&#10;        _binding = DashboardBinding.inflate(inflater, container, false)&#10;        return binding.root&#10;    }&#10;&#10;    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {&#10;        super.onViewCreated(view, savedInstanceState)&#10;&#10;        binding.buttonFirst.setOnClickListener {&#10;            findNavController().navigate(R.id.action_dashboard_to_camera)&#10;        }&#10;&#10;        binding.buttonStream.setOnClickListener {&#10;            findNavController().navigate(R.id.action_dashboard_to_stream)&#10;        }&#10;&#10;        binding.startServiceBtn.setOnClickListener { ensurePermissionsAndStart() }&#10;        binding.stopServiceBtn.setOnClickListener { stopBackgroundService() }&#10;&#10;        // Toggle visibility of URL input depending on selected source&#10;        binding.sourceRadioGroup.setOnCheckedChangeListener { _, checkedId -&gt;&#10;            val streamSelected = checkedId == R.id.radioSourceStream&#10;            binding.streamUrlInput.visibility = if (streamSelected) View.VISIBLE else View.GONE&#10;        }&#10;        // Initialize visibility&#10;        binding.streamUrlInput.visibility = if (binding.sourceRadioGroup.checkedRadioButtonId == R.id.radioSourceStream) View.VISIBLE else View.GONE&#10;&#10;        // Try binding if service is already running&#10;        bindToService()&#10;    }&#10;&#10;    private fun isPhoneSourceSelected(): Boolean =&#10;        binding.sourceRadioGroup.checkedRadioButtonId == R.id.radioSourcePhone&#10;&#10;    private fun ensurePermissionsAndStart() {&#10;        // If phone camera selected, ensure CAMERA permission first&#10;        if (isPhoneSourceSelected()) {&#10;            val camGranted = ContextCompat.checkSelfPermission(requireContext(), Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED&#10;            if (!camGranted) {&#10;                requestPermissions(arrayOf(Manifest.permission.CAMERA), REQ_CAMERA)&#10;                return&#10;            }&#10;        }&#10;        // Ensure notification permission on Android 13+&#10;        if (Build.VERSION.SDK_INT &gt;= 33) {&#10;            val notifGranted = ContextCompat.checkSelfPermission(requireContext(), Manifest.permission.POST_NOTIFICATIONS) == PackageManager.PERMISSION_GRANTED&#10;            if (!notifGranted) {&#10;                requestPermissions(arrayOf(Manifest.permission.POST_NOTIFICATIONS), REQ_NOTIF)&#10;                return&#10;            }&#10;        }&#10;        startBackgroundService()&#10;    }&#10;&#10;    private fun startBackgroundService() {&#10;        val phoneSelected = isPhoneSourceSelected()&#10;        val intent = Intent(requireContext(), DrowsinessDetectionService::class.java).apply {&#10;            action = DrowsinessDetectionService.ACTION_START&#10;            putExtra(DrowsinessDetectionService.EXTRA_SOURCE, if (phoneSelected) DrowsinessDetectionService.SOURCE_PHONE_CAMERA else DrowsinessDetectionService.SOURCE_STREAM)&#10;            if (!phoneSelected) {&#10;                val url = binding.streamUrlInput.text?.toString()?.trim().orEmpty()&#10;                if (url.isEmpty()) {&#10;                    Toast.makeText(requireContext(), &quot;Ingresa la URL del stream&quot;, Toast.LENGTH_SHORT).show()&#10;                    return&#10;                }&#10;                putExtra(DrowsinessDetectionService.EXTRA_STREAM_URL, url)&#10;            }&#10;        }&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {&#10;            requireContext().startForegroundService(intent)&#10;        } else {&#10;            requireContext().startService(intent)&#10;        }&#10;        bindToService()&#10;        updateServiceStatus(&quot;Iniciando…&quot;)&#10;    }&#10;&#10;    private fun stopBackgroundService() {&#10;        val intent = Intent(requireContext(), DrowsinessDetectionService::class.java).apply {&#10;            action = DrowsinessDetectionService.ACTION_STOP&#10;        }&#10;        requireContext().startService(intent)&#10;        unbindFromService()&#10;        updateServiceStatus(&quot;Estado del servicio: Inactivo&quot;)&#10;        // Clear debug frame&#10;        binding.debugFrame.setImageDrawable(null)&#10;    }&#10;&#10;    private fun bindToService() {&#10;        val intent = Intent(requireContext(), DrowsinessDetectionService::class.java)&#10;        requireContext().bindService(intent, serviceConnection, Context.BIND_AUTO_CREATE)&#10;    }&#10;&#10;    private fun unbindFromService() {&#10;        if (serviceBound) {&#10;            stateListener?.let { service?.removeStateListener(it) }&#10;            frameListener?.let { service?.removeFrameListener(it) }&#10;            stateListener = null&#10;            frameListener = null&#10;            requireContext().unbindService(serviceConnection)&#10;            serviceBound = false&#10;        }&#10;    }&#10;&#10;    private fun updateServiceStatus(state: String) {&#10;        binding.serviceStatusText.text = &quot;Estado del servicio: $state&quot;&#10;    }&#10;&#10;    override fun onRequestPermissionsResult(requestCode: Int, permissions: Array&lt;out String&gt;, grantResults: IntArray) {&#10;        super.onRequestPermissionsResult(requestCode, permissions, grantResults)&#10;        when (requestCode) {&#10;            REQ_NOTIF -&gt; {&#10;                if (grantResults.isNotEmpty() &amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {&#10;                    startBackgroundService()&#10;                } else {&#10;                    Toast.makeText(requireContext(), &quot;Permiso de notificaciones denegado&quot;, Toast.LENGTH_SHORT).show()&#10;                }&#10;            }&#10;            REQ_CAMERA -&gt; {&#10;                if (grantResults.isNotEmpty() &amp;&amp; grantResults[0] == PackageManager.PERMISSION_GRANTED) {&#10;                    // After camera granted, continue with notification check/start&#10;                    ensurePermissionsAndStart()&#10;                } else {&#10;                    Toast.makeText(requireContext(), &quot;Permiso de cámara denegado&quot;, Toast.LENGTH_SHORT).show()&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    override fun onDestroyView() {&#10;        super.onDestroyView()&#10;        unbindFromService()&#10;        _binding = null&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/res/menu/menu_stream.xml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/res/menu/menu_stream.xml" />
              <option name="updatedContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;menu xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;&#10;    &lt;item&#10;        android:id=&quot;@+id/action_stop_service&quot;&#10;        android:title=&quot;Detener servicio&quot;&#10;        android:showAsAction=&quot;never&quot; /&gt;&#10;&lt;/menu&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>